<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Plan de estudios - Física UBA</title>
  <style>
    body { font-family: sans-serif; margin:0; padding:0; background:#f2f6f9; color:#333; }
    header { display:flex; align-items:center; justify-content:space-between; background:#e1ecf4; padding:10px 20px; flex-wrap: wrap; }
    header .left, header .right { display:flex; align-items:center; gap:10px; }
    header img { height:50px; }
    header h1 { flex:1; text-align:center; color:#2b5d84; font-size:1.4rem; margin:0; }
    .progress-bar { width:150px; height:10px; background:#ddd; border-radius:5px; overflow:hidden; }
    .progress-bar-inner { height:100%; width:0%; background:#2b5d84; transition: width .5s ease; }
    .controls { text-align:center; margin:10px; }
    .controls button { background:#e74c3c; color:#fff; border:none; padding:8px 12px; border-radius:5px; cursor:pointer; }
    .container { display:flex; flex-wrap: wrap; justify-content:center; padding:10px; }
    .year-column { margin:10px; min-width:220px; flex:1; }
    .year-column h2 { text-align:center; color:#2b5d84; }
    .subject { background:#fff; border:1px solid #cbd5e0; border-radius:5px; padding:8px; margin:5px 0; position:relative; display:flex; flex-direction:column; font-size:0.9rem; }
    .subject.locked { opacity:0.5; pointer-events:none; cursor:not-allowed; }
    .tooltip { position:absolute; background:#333; color:#fff; padding:4px 6px; border-radius:3px; font-size:0.75rem; top:-5px; right:5px; display:none; }
    .subject.locked:hover .tooltip { display:block; }
    input[type="text"] { width:50px; padding:2px; margin-top:4px; font-size:0.8rem; }
    .regular { background:#d0ecf9; }
    .approved { background:#c9f4d2; }
    @media (max-width:768px){
      header { flex-direction:column; align-items:stretch; }
      header .left, header .right { margin:5px 0; justify-content:center; }
    }
  </style>
</head>
<body>
<header>
  <div class="left">
    <img src="UBA_logo_University_of_Buenos_Aires.webp" alt="UBA" />
    <div>
      <small id="materiasContador">Materias aprobadas:</small><br>
      <div class="progress-bar"><div class="progress-bar-inner" id="progBar"></div></div>
    </div>
  </div>
  <h1>Plan de estudios - Física UBA</h1>
  <div class="right">
    <div>
      <small>Promedio:</small><br>
      <span id="promedio">‑</span>
    </div>
    <img src="logo-wide.webp" alt="Física" />
  </div>
</header>
<div class="controls">
  <button onclick="resetProgress()">Reiniciar Progreso</button>
</div>
<div class="container" id="curriculum"></div>

<script>
  function doConfetti(){
    const canvas=document.createElement('canvas');
    canvas.style.position='fixed'; canvas.style.top=0; canvas.style.left=0;
    canvas.width=window.innerWidth; canvas.height=window.innerHeight;
    document.body.appendChild(canvas);
    const ctx=canvas.getContext('2d'), pieces=[];
    for(let i=0;i<150;i++){ pieces.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*6+4, dx:(Math.random()-0.5)*4, dy:Math.random()*-7-3, color:`hsl(${Math.random()*360},70%,60%)`}); }
    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      pieces.forEach(p=>{
        p.x+=p.dx; p.y+=p.dy; p.dy+=0.3;
        ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,2*Math.PI); ctx.fill();
      });
      pieces.forEach((p,i)=>{ if(p.y>canvas.height){ pieces.splice(i,1); } });
      if(pieces.length) requestAnimationFrame(draw); else canvas.remove();
    }
    draw();
  }

  const data={ /* ... misma estructura con materias ... */ };

  let state=JSON.parse(localStorage.getItem("malla_fisica"))||{};
  function save(){ localStorage.setItem("malla_fisica",JSON.stringify(state)); }
  function resetProgress(){ if(confirm("¿Reiniciar progreso?")){ localStorage.removeItem("malla_fisica"); location.reload(); } }

  function lockCheck(subj, statuses){
    if(!subj.req) return false;
    let unmet=[];
    subj.req.forEach(r=>{
      if(r==="CBC"){
        const ok=data["CBC"].every(s=>statuses[s.name]?.regular);
        if(!ok) unmet.push("CBC completo");
      } else if(r==="ALL:regular"){
        if(!Object.values(statuses).every(s=>s.regular)) unmet.push("Todo regularizado");
      } else {
        let [n,t="regular"]=r.split(":");
        const s=statuses[n];
        if(!s || !s[t]) unmet.push(`${n} (${t})`);
      }
    });
    return unmet.length?unmet:false;
  }

  function render(){
    const cont=document.getElementById("curriculum");
    cont.innerHTML="";
    let total=0, approved=0, sum=0, count=0;
    const statuses={};
    for(let year in data){
      data[year].forEach(s=>statuses[s.name]=state[s.name]||{});
    }

    for(let year in data){
      const col=document.createElement("div"); col.className="year-column";
      col.innerHTML=`<h2>${year}</h2>`;
      data[year].forEach(subj=>{
        total++;
        const div=document.createElement("div"); div.className="subject";
        const s=state[subj.name]||{};
        const locked=lockCheck(subj,statuses);
        if(locked){ div.classList.add("locked"); const tt=document.createElement("div"); tt.className="tooltip"; tt.textContent="Requiere: "+locked.join(", "); div.appendChild(tt); }
        if(s.regular) div.classList.add("regular");
        if(s.aprobada) div.classList.add("approved");

        const chk=document.createElement("input"); chk.type="checkbox"; chk.checked=s.regular||false; chk.disabled=!!locked;
        chk.onchange=()=>{
          s.regular=chk.checked; state[subj.name]=s;
          save(); render();
        };

        const label=document.createElement("label"); label.append(chk,document.createTextNode(" Regular"));

        const nota=document.createElement("input"); nota.type="text"; nota.placeholder="Nota"; nota.value=s.nota||""; nota.disabled=!!locked;
        nota.oninput=()=>{
          let v=parseFloat(nota.value);
          if(!isNaN(v) && v>=4){
            const yaEstabaAprobada = s.aprobada;
            s.aprobada = true;
            s.nota = v;
            if(!s.regular) s.regular = true;
            state[subj.name] = s;
            save();

            const aprobadasPrevias = Object.values(state).filter(x => x.aprobada).length;
            render();

            const aprobadasActuales = Object.values(state).filter(x => x.aprobada).length;
            const totalMaterias = Object.values(data).reduce((acc, year) => acc + year.length, 0);

            if (!yaEstabaAprobada && aprobadasActuales === totalMaterias) {
              doConfetti();
            }
          } else {
            s.aprobada = false;
            s.nota = nota.value;
            state[subj.name] = s;
            save();
            render();
          }
        };

        div.innerHTML=`<strong>${subj.editable? `<input value="${subj.name}" onchange="rename('${subj.name}', this.value)">`: subj.name}</strong>`;
        div.append(label, nota);
        col.appendChild(div);
        if(s.aprobada){
          approved++;
          if(year!=="CBC"){ sum+=parseFloat(s.nota)||0; count++; }
        }
      });
      cont.appendChild(col);
    }

    document.getElementById("progBar").style.width=`${(approved/total*100)||0}%`;
    document.getElementById("promedio").textContent = count ? (sum / count).toFixed(2) : "-";
    document.getElementById("materiasContador").textContent = `Materias aprobadas: ${approved} / ${total}`;
  }

  function rename(oldn,newn){ if(newn&&newn.trim()){ state[newn]=state[oldn]; delete state[oldn]; save(); render(); } }

  render();
</script>
</body>
</html>

