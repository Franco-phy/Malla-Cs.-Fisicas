<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Malla Curricular F칤sica UBA</title>
  <style>
    :root { --main-hue: 210; }
    body { font-family: Arial, sans-serif; background: #f5f7fa; color: #333; margin: 20px; }
    .stats { margin-bottom: 15px; font-size: 1rem; }
    .stats span { margin-right: 20px; }
    .grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
    .column { background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    .column h3 { margin-top: 0; font-size: 1.1rem; text-align: center; }
    .subject { background: hsl(var(--main-hue), 50%, 95%); margin: 5px 0; padding: 8px; border-radius: 6px; cursor: pointer; position: relative; }
    .subject.locked { opacity: 0.5; cursor: default; }
    .subject .badge { font-size: 0.8rem; padding: 2px 4px; border-radius: 4px; margin-left: 5px; }
    .subject.regular { border-left: 4px solid hsl(var(--main-hue), 80%, 60%); }
    .subject.finalized { border-left: 4px solid hsl(var(--main-hue), 60%, 40%); }
    .notification { position: fixed; top: 20px; right: 20px; background: hsl(var(--main-hue), 50%, 80%); padding: 10px 15px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); animation: fade 3s forwards; }
    @keyframes fade { 0% { opacity: 0; transform: translateY(-20px);} 10%, 90% { opacity: 1; transform: translateY(0);} 100% { opacity: 0; transform: translateY(-20px);} }
    .note-input { position: absolute; top: 5px; right: 5px; font-size: 0.8em; background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 2px 4px; width: 2em; text-align: center; }
  </style>
</head>
<body>
  <div class="stats">
    <span id="count">Aprobadas: 0/0 (0%)</span>
    <span id="average">Promedio: 0.00</span>
  </div>
  <div class="grid" id="grid"></div>

  <script>
    const subjects = [...]; // mantener la definici칩n original
    const cols = ['CBC','1er A침o','2do A침o','3er A침o','4to A침o','5to A침o'];
    const grid = document.getElementById('grid');

    function loadState() {
      subjects.forEach(s => {
        const data = JSON.parse(localStorage.getItem(s.id) || 'null');
        s.status = data?.status || null;
        s.grade = data?.grade || '';
        if(s.optativa) s.title = data?.title || s.title;
      });
    }

    function saveState(s) {
      localStorage.setItem(s.id, JSON.stringify({ status: s.status, grade: s.grade, title: s.title }));
    }

    function notify(msg) {
      const n = document.createElement('div'); n.className='notification'; n.textContent=msg;
      document.body.appendChild(n);
      setTimeout(() => n.remove(), 3000);
    }

    function render() {
      grid.querySelectorAll('.subject').forEach(el=>el.remove());
      subjects.forEach(s => {
        const parent = grid.children[s.col];
        const div = document.createElement('div'); div.className='subject'; div.id=s.id;
        div.textContent = s.title;
        if(s.status==='regular') div.classList.add('regular');
        if(s.grade) div.classList.add('finalized');
        if(s.optativa) div.contentEditable = true;

        const missing = checkPrereq(s);
        if(missing.length) { div.classList.add('locked'); div.title = 'Falta: ' + missing.join(', '); }

        div.onclick = () => onSubjectClick(s);

        // Campo para nota
        const note = document.createElement('input');
        note.className = 'note-input';
        note.type = 'text';
        note.maxLength = 2;
        note.placeholder = '游닇';
        note.value = s.grade || '';
        note.title = 'Ingresar nota';
        note.oninput = (e) => {
          s.grade = note.value;
          saveState(s);
          render();
          if (s.grade && !s.status) {
            s.status = 'regular';
            notify('Buen Trabajo');
          }
        };
        div.appendChild(note);

        parent.appendChild(div);
      });
      updateStats();
    }

    function checkPrereq(s) {
      const faltan = [];
      s.prereq.forEach(p => {
        let id = p.id || p;
        let needed = p.status || 'regular';
        const subj = subjects.find(x=>x.id===id);
        if(!subj.status || (needed==='approved' && !subj.grade) || (needed==='regular' && subj.status!=='regular')) {
          faltan.push(subj.title);
        }
      });
      return faltan;
    }

    function onSubjectClick(s) {
      const div = document.getElementById(s.id);
      if(div.classList.contains('locked')) return;
      if(!s.status) {
        s.status='regular'; saveState(s); render(); notify('Buen Trabajo');
      }
    }

    function updateStats() {
      const nonCBC = subjects.filter(s=>s.col>0);
      const approved = nonCBC.filter(s=>s.grade);
      const countEl = document.getElementById('count');
      const pct = nonCBC.length? Math.round(approved.length/nonCBC.length*100):0;
      countEl.textContent = `Aprobadas: ${approved.length}/${nonCBC.length} (${pct}%)`;
      const grades = approved.map(s=>parseFloat(s.grade)||0).filter(n=>n>0);
      const avg = grades.length? (grades.reduce((a,b)=>a+b,0)/grades.length).toFixed(2): '0.00';
      document.getElementById('average').textContent = `Promedio: ${avg}`;
    }

    function setupOptativa() {
      subjects.filter(s=>s.optativa).forEach(s=>{
        const div = document.getElementById(s.id);
        div.addEventListener('input', () => { s.title = div.textContent; saveState(s); });
      });
    }

    loadState(); render(); setupOptativa();
  </script>
</body>
</html>
